{"version":3,"sources":["../index.js"],"names":["compose","connect","create","arguments","type","appType","apply","uniqueId","Date","getTime","context","React","createContext","wiredActionCache","actionType","generateId","toString","wire","appId","actions","dispatch","result","actionName","action","__id","cacheKey","args","funcs","length","reduce","prev","next","x","stateToProps","component","ComponentWrapper","nextProps","hasChange","propName","nextValue","prevValue","props","createElement","Component","Consumer","contextValue","value","Object","assign","undefined","PureComponent","inititalState","middlewares","push","parentApp","originalApi","getState","currentState","subscribe","subscriber","subscribers","unsubscribed","actionResult","nextState","createContextValue","notify","chain","map","middleware","api","wiredActions","unsubscribedIndexes","i","unsubcribed","splice","pop","provider","unsubscribe","forceUpdate","Provider","children"],"mappings":"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","file":"index.js","sourcesContent":["import React from \"react\";\r\n\r\nlet uniqueId = new Date().getTime();\r\nconst context = React.createContext();\r\nconst wiredActionCache = {};\r\nconst appType = \"@@App\";\r\nconst actionType = \"@@Action\";\r\n\r\nfunction generateId() {\r\n  return (uniqueId++).toString(16);\r\n}\r\n\r\nfunction wire(appId, actions, dispatch) {\r\n  const result = {};\r\n  for (let actionName in actions) {\r\n    const action = actions[actionName];\r\n    if (!action.__id) {\r\n      action.__id = generateId();\r\n    }\r\n    if (action.type === actionType) {\r\n      result[actionName] = action;\r\n      continue;\r\n    }\r\n\r\n    const cacheKey = appId + \".\" + action.__id;\r\n    result[actionName] =\r\n      wiredActionCache[cacheKey] ||\r\n      (wiredActionCache[cacheKey] = function(...args) {\r\n        return dispatch(action, ...args);\r\n      });\r\n  }\r\n  return result;\r\n}\r\n\r\nexport function compose(...funcs) {\r\n  return funcs.length === 1\r\n    ? funcs[0]\r\n    : funcs.reduce((prev, next) => (...args) => prev(next(...args)), x => x);\r\n}\r\n\r\n/**\r\n * copy from https://github.com/reduxjs/redux/blob/master/src/applyMiddleware.js\r\n */\r\n\r\nexport function connect(stateToProps, actions) {\r\n  return function(component) {\r\n    class ComponentWrapper extends React.Component {\r\n      shouldComponentUpdate(nextProps) {\r\n        let hasChange = false;\r\n        for (let propName in nextProps) {\r\n          const nextValue = nextProps[propName];\r\n          const prevValue = this.props[propName];\r\n          if (\r\n            nextValue === prevValue ||\r\n            // skip function type checking\r\n            (typeof nextValue === \"function\" && typeof prevValue === \"function\")\r\n          )\r\n            continue;\r\n\r\n          if (nextValue instanceof Date && prevValue instanceof Date) {\r\n            if (nextValue.getTime() === prevValue.getTime()) {\r\n              continue;\r\n            }\r\n          }\r\n\r\n          hasChange = true;\r\n          break;\r\n        }\r\n        return hasChange;\r\n      }\r\n\r\n      render() {\r\n        return React.createElement(component, this.props);\r\n      }\r\n    }\r\n\r\n    return class ConsumerWrapper extends React.PureComponent {\r\n      render() {\r\n        return React.createElement(context.Consumer, {}, contextValue => {\r\n          return React.createElement(\r\n            ComponentWrapper,\r\n            stateToProps(\r\n              contextValue.value,\r\n              this.props,\r\n              Object.assign(\r\n                {},\r\n                contextValue.actions,\r\n                actions\r\n                  ? wire(contextValue.appId, actions, contextValue.dispatch)\r\n                  : undefined\r\n              )\r\n            )\r\n          );\r\n        });\r\n      }\r\n    };\r\n  };\r\n}\r\n\r\nexport function create(inititalState = {}, actions = {}, ...middlewares) {\r\n  if (typeof actions === \"function\") {\r\n    actions = {};\r\n    middlewares.push(actions);\r\n  }\r\n\r\n  const parentApp =\r\n    inititalState && inititalState.type === appType ? inititalState : undefined;\r\n  const appId = generateId();\r\n  const originalApi = {\r\n    getState() {\r\n      return parentApp ? parentApp.getState() : currentState;\r\n    },\r\n\r\n    subscribe(subscriber) {\r\n      if (parentApp) {\r\n        return parentApp.subscribe(subscriber);\r\n      }\r\n\r\n      subscribers.push(subscriber);\r\n      return function() {\r\n        subscriber.unsubscribed = true;\r\n      };\r\n    },\r\n\r\n    dispatch(action, ...args) {\r\n      if (parentApp) {\r\n        return parentApp.dispatch(action, ...args);\r\n      }\r\n\r\n      if (typeof action !== \"function\") return action;\r\n\r\n      let actionResult = action.apply(null, args);\r\n      if (typeof actionResult === \"function\") {\r\n        const nextState = actionResult(currentState);\r\n        if (nextState !== currentState) {\r\n          currentState = nextState;\r\n          contextValue = createContextValue();\r\n          // notify changes\r\n          notify();\r\n          return undefined;\r\n        }\r\n      }\r\n      return actionResult;\r\n    }\r\n  };\r\n  const chain = middlewares.map(middleware => middleware(originalApi));\r\n\r\n  const api = Object.assign({}, originalApi, {\r\n    dispatch: compose(...chain)(originalApi.dispatch)\r\n  });\r\n\r\n  const wiredActions = wire(\r\n    appId,\r\n    Object.assign({}, parentApp ? parentApp.actions : null, actions),\r\n    api.dispatch\r\n  );\r\n  const subscribers = [];\r\n\r\n  let currentState = inititalState;\r\n  let contextValue = createContextValue();\r\n\r\n  function createContextValue() {\r\n    return {\r\n      appId,\r\n      value: api.getState(),\r\n      actions: wiredActions,\r\n      dispatch: api.dispatch\r\n    };\r\n  }\r\n\r\n  function notify() {\r\n    const unsubscribedIndexes = [];\r\n\r\n    for (let i = 0; i < subscribers.length; i++) {\r\n      const subscriber = subscribers[i];\r\n      if (subscriber.unsubcribed) {\r\n        unsubscribedIndexes.push(i);\r\n        continue;\r\n      }\r\n      subscriber(currentState);\r\n    }\r\n    while (unsubscribedIndexes.length) {\r\n      subscribers.splice(unsubscribedIndexes.pop(), 1);\r\n    }\r\n  }\r\n\r\n  if (parentApp) {\r\n    parentApp.subscribe(() => (contextValue = createContextValue()));\r\n  }\r\n\r\n  const provider = class ProviderWrapper extends React.PureComponent {\r\n    componentDidMount() {\r\n      this.unsubscribe = api.subscribe(() => this.forceUpdate());\r\n    }\r\n\r\n    componentWillUnmount() {\r\n      this.unsubscribe();\r\n    }\r\n\r\n    render() {\r\n      return React.createElement(\r\n        context.Provider,\r\n        { value: contextValue },\r\n        this.props.children\r\n      );\r\n    }\r\n  };\r\n\r\n  return Object.assign(\r\n    provider,\r\n    {\r\n      type: appType,\r\n      Provider: provider,\r\n      actions: wiredActions\r\n    },\r\n    api\r\n  );\r\n}\r\n\r\nexport default function() {\r\n  if (\r\n    typeof arguments[0] !== \"function\" ||\r\n    (arguments[0] && arguments[0].type === appType)\r\n  ) {\r\n    return create.apply(null, arguments);\r\n  }\r\n  return connect.apply(null, arguments);\r\n}"]}